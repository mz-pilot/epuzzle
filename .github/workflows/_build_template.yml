name: Reusable C++ Build Template

on:
  workflow_call:
    inputs:
      build_types:
        required: true
        type: string
      upload_artifacts:
        required: false
        type: boolean
        default: false
      
    outputs:
      artifact_id:
        description: "The run ID to download artifacts from later."
        value: ${{ jobs.build.outputs.artifact_id }}

jobs:
  build:
    name: Build & Test ${{ matrix.os }} (${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    
    outputs:
      artifact_id: ${{ github.run_id }}
      
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: ${{ fromJson(inputs.build_types) }}

    defaults:
      run:
        shell: bash

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v6

      - name: 2. (Windows) Setup MSVC environment
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1 # prefpare environment for Ninja

      - name: 2. (Linux) Install dependencies
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get install -y ninja-build


      - name: 3. Extract Version
        id: get_version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/v*.*.* ]]; then
            GIT_TAG=${GITHUB_REF#refs/tags/}
          else
            GIT_TAG="v0.0.0-pr-${GITHUB_SHA::7}"
          fi
          echo "Detected tag: $GIT_TAG"
          echo "GIT_TAG=$GIT_TAG" >> $GITHUB_ENV

      - name: 4. Configure CMake
        run: |
          cmake -S . -B build -G "Ninja" \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DEPUZZLE_GIT_TAG=${{ env.GIT_TAG }} \
            -DEPUZZLE_BUILD_TESTS=ON \
            -DEPUZZLE_BUILD_APPS=ON

      - name: 5. Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: 6. Test
        working-directory: ./build
        run: ctest -C ${{ matrix.build_type }} --output-on-failure --verbose

      
      - name: 7 Package Application (CPack)
        if: matrix.build_type == 'Release' || inputs.upload_artifacts
        working-directory: ./build
        run: cpack -C ${{ matrix.build_type }}

      - name: 7.1 (Windows) Package Debug Symbols (PDB)
        if: inputs.upload_artifacts && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ReleaseDir = "${{ matrix.build_type }}"
          $cpackFile = Get-ChildItem -Path build -Filter *.zip | Select-Object -First 1
          if ($cpackFile -ne $null) {
              $baseName = $cpackFile.BaseName
              $pdbZipName = "${baseName}-debug-symbols.zip"
              Compress-Archive -Path build/bin/pdb/*.pdb -DestinationPath "build/$pdbZipName"              
              Write-Host "PDB symbols packaged as: $pdbZipName"
          } else {
              Write-Host "Warning: CPack ZIP file not found. Skipping PDB packaging."
          }

      - name: 7.1 (Linux) Verify Deb Package (install-launch-uninstall)
        if: matrix.build_type == 'Release' && matrix.os == 'ubuntu-latest'
        working-directory: ./build
        run: |
          DEB_FILE=$(ls *.deb | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "::error::No .deb file found to test!"
            exit 1
          fi
          echo "Found package: $DEB_FILE"
          PKG_NAME=$(dpkg-deb -f "$DEB_FILE" Package)
          echo "Detected package name: $PKG_NAME"

          echo "Installing..."
          sudo apt-get install -y "./$DEB_FILE"
          if ! command -v $PKG_NAME &> /dev/null; then
             echo "::error::Binary '$PKG_NAME' not found in PATH after installation!"
             exit 1
          fi
          echo "Installation verified successfully"

          echo "Launch..."
          APP_OUTPUT=$($PKG_NAME --version)
          EXPECTED_VER=$(echo "$GIT_TAG" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [[ "$APP_OUTPUT" == *"$EXPECTED_VER"* ]]; then
             echo "Version check passed: '$APP_OUTPUT' contains expected '$EXPECTED_VER'"
          else
             echo "::error::Version mismatch! App output: '$APP_OUTPUT', expected: '$EXPECTED_VER'"
             exit 1
          fi
          echo "Launch verified successfully"

          echo "Uninstalling..."
          sudo apt-get remove -y $PKG_NAME
          if command -v $PKG_NAME &> /dev/null; then
             echo "::error::Binary still exists after removal!"
             exit 1
          fi         
          echo "Uninstallation verified successfully"

      - name: 7.2 (Windows) Smoke Test (unzip-launch)
        if: matrix.build_type == 'Release' && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $zipFile = Get-ChildItem -Path build -Filter *.zip | Select-Object -First 1
          if (-not $zipFile) {
              Write-Error "No ZIP package found for testing!"
              exit 1
          }
          Write-Host "Found package: $($zipFile.FullName)."

          Write-Host "Unzip..."
          $testDir = "build/test_install"
          New-Item -ItemType Directory -Force -Path $testDir
          Expand-Archive -Path $zipFile.FullName -DestinationPath $testDir
          $exePath = Get-ChildItem -Path $testDir -Filter "epuzzle.exe" -Recurse | Select-Object -First 1
          if (-not $exePath) {
              Write-Error "Binary 'epuzzle.exe' not found inside the ZIP!"
              exit 1
          }
          Write-Host "Unzip verified successfully"

          Write-Host "Launch $($exePath.FullName) ..."
          $expectedVer = "unknown"
          if ("${{ env.GIT_TAG }}" -match 'v(\d+\.\d+\.\d+).*') {
              $expectedVer = $matches[1]
          }
          try {
              $OutputEncoding = [System.Text.Encoding]::UTF8
              [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
              $appOutput = & $exePath.FullName --version | Out-String
              Write-Host "App output: $appOutput"
              
              if ($appOutput -like "*$expectedVer*") {
                  Write-Host "Version check passed: $appOutput contains $expectedVer"
              } else {
                  Write-Error "Version mismatch! Got: $appOutput, expected: $expectedVer"
                  exit 1
              }
          } catch {
              Write-Error "Application failed to start! Possibly missing DLLs or dependencies."
              exit 1
          }
          Write-Host "Launch verified successfully"

      - name: 8. Upload Artifacts
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v6
        with:
          name: package-${{ matrix.os }}-${{ matrix.build_type }}
          path: |
            build/*.deb
            build/*.tar.gz
            build/*.zip