name: Reusable C++ Build Template

on:
  workflow_call:
    inputs:
      build_types:
        required: true
        type: string
      upload_artifacts:
        required: false
        type: boolean
        default: false
      
    outputs:
      artifact_id:
        description: "The run ID to download artifacts from later."
        value: ${{ jobs.build.outputs.artifact_id }}

jobs:
  build:
    name: Build & Test ${{ matrix.os }} (${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    
    outputs:
      artifact_id: ${{ github.run_id }}
      
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: ${{ fromJson(inputs.build_types) }}

    defaults:
      run:
        shell: bash

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v6

      - name: 2. Setup MSVC environment (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1 # prefpare environment for Ninja

      - name: 3. Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get install -y ninja-build


      - name: 4. Extract Version
        id: get_version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # remove prefix 'refs/tags/' or 'refs/tags/v'
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION=${VERSION#v}
          else
            VERSION="0.0.0-pr-${GITHUB_SHA::7}"
          fi
          echo "Detected version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: 5. Configure CMake
        run: |
          cmake -S . -B build -G "Ninja" \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DEPUZZLE_BUILD_VERSION=${{ env.VERSION }} \
            -DEPUZZLE_BUILD_TESTS=ON \
            -DEPUZZLE_BUILD_APPS=ON

      - name: 6. Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: 7. Test
        working-directory: ./build
        run: ctest -C ${{ matrix.build_type }} --output-on-failure --verbose

      
      - name: 8. Package Application (CPack)
        if: inputs.upload_artifacts
        working-directory: ./build
        run: cpack -C ${{ matrix.build_type }}

      - name: 9. Package Debug Symbols (PDB) - Windows
        if: inputs.upload_artifacts && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ReleaseDir = "${{ matrix.build_type }}"
          $cpackFile = Get-ChildItem -Path build -Filter *.zip | Select-Object -First 1
          if ($cpackFile -ne $null) {
              $baseName = $cpackFile.BaseName
              $pdbZipName = "${baseName}-debug-symbols.zip"
              Compress-Archive -Path build/bin/pdb/*.pdb -DestinationPath "build/$pdbZipName"              
              Write-Host "PDB symbols packaged as: $pdbZipName"
          } else {
              Write-Host "Warning: CPack ZIP file not found. Skipping PDB packaging."
          }

      - name: 10. Upload Artifacts
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v6
        with:
          # Используем уникальное имя, чтобы не было конфликтов (os-buildtype)
          name: package-${{ matrix.os }}-${{ matrix.build_type }}
          path: |
            build/*.tar.gz
            build/*.zip